# terraform-azure-mcaf-azdo-buildagent-aci
Terraform module that will deploy some infra that could be used for Azure Devops icm Terraform

<!-- BEGIN_TF_DOCS -->
## Requirements

| Name | Version |
|------|---------|
| <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) | >= 1.7 |
| <a name="requirement_azurerm"></a> [azurerm](#requirement\_azurerm) | >= 4 |

## Providers

| Name | Version |
|------|---------|
| <a name="provider_azurerm"></a> [azurerm](#provider\_azurerm) | >= 4 |

## Modules

No modules.

## Resources

| Name | Type |
|------|------|
| [azurerm_container_group.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/container_group) | resource |
| [azurerm_container_registry.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/container_registry) | resource |
| [azurerm_resource_group.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/resource_group) | resource |
| [azurerm_role_assignment.acr](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/role_assignment) | resource |
| [azurerm_role_assignment.cmk](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/role_assignment) | resource |
| [azurerm_role_assignment.extra](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/role_assignment) | resource |
| [azurerm_role_assignment.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/role_assignment) | resource |
| [azurerm_storage_account.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/storage_account) | resource |
| [azurerm_storage_account_customer_managed_key.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/storage_account_customer_managed_key) | resource |
| [azurerm_storage_account_network_rules.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/storage_account_network_rules) | resource |
| [azurerm_storage_container.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/storage_container) | resource |
| [azurerm_user_assigned_identity.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/user_assigned_identity) | resource |
| [azurerm_client_config.current](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/data-sources/client_config) | data source |

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| <a name="input_container_group"></a> [container\_group](#input\_container\_group) | This object describes the configuration for an Azure Container Instance.<br><br>  - `name`                            = (Required) - The name of the Container Group.<br>  - `location`                        = (Optional) - The location of the Container Group. Defaults to the location of the resource group.<br>  - `resource_group_name`             = (Optional) - The name of the resource group in which to create the Container Group. Defaults to the resource group of the parent module.<br>  - `os_type`                         = (Optional) - The OS type of the Container Group. Valid options are Linux and Windows. Defaults to Linux.<br>  - `subnet_ids`                      = (Required) - A list of subnet IDs to deploy the Container Group in.<br>  - `restart_policy`                  = (Optional) - The restart policy for the Container Group. Valid options are Always, OnFailure, and Never. Defaults to OnFailure.<br>  - `priority`                        = (Optional) - The priority of the Container Group. Valid options are Regular and Low. Defaults to Regular.<br>  - `key_vault_key_id`                = (Optional) - The Key Vault key ID for the Container Group.<br>  - `key_vault_user_assigned_identity_id` = (Optional) - The Key Vault user-assigned identity ID for the Container Group.<br><br>  Example Inputs:<pre>hcl<br>  module "aci" {<br>    name = "mycontainergroup"<br>    subnet_ids = [<br>      azurerm_subnet.this.id<br>    ]<br>  }</pre> | <pre>object({<br>    name                                = string<br>    location                            = optional(string)<br>    resource_group_name                 = optional(string)<br>    os_type                             = optional(string, "Linux")<br>    subnet_ids                          = list(string)<br>    restart_policy                      = optional(string, "OnFailure")<br>    priority                            = optional(string, "Regular")<br>    key_vault_key_id                    = optional(string)<br>    key_vault_user_assigned_identity_id = optional(string)<br>    dns_name_label                      = optional(string)<br>    dns_name_label_reuse_policy         = optional(string)<br>    managed_identities = optional(object({<br>      system_assigned            = optional(bool, false)<br>      user_assigned_resource_ids = optional(set(string), [])<br>    }), {})<br>  })</pre> | n/a | yes |
| <a name="input_storage_account"></a> [storage\_account](#input\_storage\_account) | This object describes the configuration for an Azure Storage Account.<br><br>- `name`                              = (Required) - The name of the storage account.<br>- `account_tier`                      = (Optional) - The Tier to use for this storage account. Valid options are Standard and Premium. Defaults to Standard.<br>- `account_replication_type`          = (Optional) - The type of replication to use for this storage account. Valid options are LRS, GRS, RAGRS, ZRS, GZRS, and RA\_GZRS. Defaults to GRS.<br>- `account_kind`                      = (Optional) - The Kind of account to create. Valid options are Storage, StorageV2, BlobStorage, FileStorage, BlockBlobStorage, and StorageV2. Defaults to StorageV2.<br>- `access_tier`                       = (Optional) - The access tier for the storage account. Valid options are Hot and Cool. Defaults to Hot.<br>- `shared_access_key_enabled`         = (Optional) - Allow or disallow shared access keys for this storage account. Defaults to false.<br>- `https_traffic_only_enabled`        = (Optional) - Allow or disallow only HTTPS traffic to this storage account. Defaults to true.<br>- `min_tls_version`                   = (Optional) - The minimum TLS version to allow for requests to this storage account. Valid options are TLS1\_0, TLS1\_1, and TLS1\_2. Defaults to TLS1\_2.<br>- `public_network_access_enabled`     = (Optional) - Allow or disallow public network access to this storage account. Defaults to false.<br>- `default_to_oauth_authentication`   = (Optional) - Allow or disallow defaulting to OAuth authentication for this storage account. Defaults to true.<br>- `infrastructure_encryption_enabled` = (Optional) - Allow or disallow infrastructure encryption for this storage account. Defaults to true.<br>- `sftp_enabled`                      = (Optional) - Allow or disallow SFTP access to this storage account. Defaults to false.<br>- `identity`                          = (Optional) - Enable or disable the system-assigned managed identity for this storage account. Defaults to true.<br>- `ip_rules`                          = (Optional) - A list of IP addresses that are allowed to access this storage account. Defaults to an empty list.<br>- `subnet_id`                         = (Optional) - A list of subnet IDs that are allowed to access this storage account. Defaults to an empty list.<br>- `network_bypass`                    = (Optional) - A list of services that are allowed to bypass the network rules. Defaults to [] but could be any of ["Logging", "Metrics", "AzureServices", "None"].<br>- `blob_delete_retention_days`        = (Optional) - The number of days to retain deleted blobs for. Defaults to 90.<br>- `container_delete_retention_days`   = (Optional) - The number of days to retain deleted containers for. Defaults to 90.<br>- `versioning_enabled`                = (Optional) - Enable or disable versioning for this storage account. Defaults to true.<br>- `change_feed_enabled`               = (Optional) - Enable or disable the change feed for this storage account. Defaults to true.<br>- `contributors`                      = (Optional) - A list of principal IDs that are allowed to be contributor on this storage account. Defaults to an empty list.<br>- `allow_nested_items_to_be_public`   = (Optional) - Allow or disallow nested items to be public. Defaults to false.<br>- `key_vault_id`                       = (Optional) - The ID of the Key Vault to<br>- `key_vault_keyname`                  = (Optional) - The name of the Key Vault key to use for encryption.<br><br>  Example Inputs:<pre>hcl<br>module "azure-devops" "this" {<br>  name                              = "storageaccountname"<br>  ip_rules                          = [ "1.2.3.4" ]<br>  subnet_id                         = [ "/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/rgname/providers/Microsoft.Network/virtualNetworks/vnetname/subnets/subnetname" ]<br><br>  contributors = [<br>    "0b9fe8e2-09cb-1234-1243-671f5b1b29fd"<br>  ]<br>}</pre> | <pre>object({<br>    name                              = string<br>    account_tier                      = optional(string, "Standard")<br>    account_replication_type          = optional(string, "GRS")<br>    account_kind                      = optional(string, "StorageV2")<br>    access_tier                       = optional(string, "Hot")<br>    shared_access_key_enabled         = optional(bool, false)<br>    https_traffic_only_enabled        = optional(bool, true)<br>    min_tls_version                   = optional(string, "TLS1_2")<br>    default_to_oauth_authentication   = optional(bool, true)<br>    infrastructure_encryption_enabled = optional(bool, true)<br>    sftp_enabled                      = optional(bool, false)<br>    identity                          = optional(bool, true)<br>    ip_rules                          = optional(list(string), [])<br>    subnet_id                         = optional(list(string), [])<br>    network_bypass                    = optional(set(string), ["None"])<br>    blob_delete_retention_days        = optional(number, 30)<br>    container_delete_retention_days   = optional(number, 30)<br>    versioning_enabled                = optional(bool, true)<br>    change_feed_enabled               = optional(bool, true)<br>    contributors                      = optional(set(string), [])<br>    allow_nested_items_to_be_public   = optional(bool, false)<br>    cmk_key_vault_id                  = optional(string, 0)<br>    cmk_key_vault_keyname             = optional(string, 0)<br>  })</pre> | n/a | yes |
| <a name="input_aci"></a> [aci](#input\_aci) | - `image` = (Required) - The image to use for the container.<br>- `cpu` = (Optional) - The CPU to allocate to the container. Defaults to 1.<br>- `memory` = (Optional) - The memory to allocate to the container. Defaults to 1.<br>- `ports` = (Required) - A list of ports to expose on the container.<br>- `volumes` = (Optional) - A map of volumes to mount to the container.<br>- `environment_variables` = (Optional) - A map of environment variables to set in the container.<br>- `secure_environment_variables` = (Optional) - A map of secure environment variables to set in the container.<br>- `commands` = (Optional) - A list of commands to run in the container. | <pre>map(object({<br>    image  = string<br>    cpu    = optional(number, "1")<br>    memory = optional(number, "1")<br>    ports = list(object({<br>      port     = number<br>      protocol = string<br>    }))<br>    volumes = optional(map(object({<br>      mount_path           = string<br>      name                 = string<br>      read_only            = optional(bool, false)<br>      empty_dir            = optional(bool, false)<br>      secret               = optional(map(string), null)<br>      storage_account_name = optional(string, null)<br>      storage_account_key  = optional(string, null)<br>      share_name           = optional(string, null)<br>      git_repo = optional(object({<br>        url       = optional(string, null)<br>        directory = optional(string, null)<br>        revision  = optional(string, null)<br>      }))<br>    })), {})<br>    environment_variables        = optional(map(string), {})<br>    secure_environment_variables = optional(map(string), {})<br>    commands                     = optional(list(string), null)<br>  }))</pre> | `{}` | no |
| <a name="input_acr"></a> [acr](#input\_acr) | This object describes the configuration for an Azure Container Registry.<br><br>- `name`                            = (Optional) - The name of the Container Registry.<br>- `identity`                        = (Optional) - Enable or disable the Managed Identity for the Container Registry. Defaults to true.<br>- `resource_group_name`             = (Optional) - The name of the resource group in which to create the Container Registry. Defaults to the resource group of the parent module.<br>- `location`                        = (Optional) - The location of the Container Registry. Defaults to the location of the resource group.<br>- `sku`                             = (Optional) - The SKU of the Container Registry. Valid options are Basic, Standard, and Premium. Defaults to Premium.<br>- `admin_enabled`                   = (Optional) - Enable or disable the Admin user for the Container Registry. Defaults to false.<br>- `public_network_access_enabled`   = (Optional) - Enable or disable public network access for the Container Registry. Defaults to false.<br>- `retention_policy_in_days`        = (Optional) - The number of days to retain untagged manifests. Defaults to 7.<br>- `network_bypass`                  = (Optional) - A string of services that are allowed to bypass the network rules. Defaults to "None" but could be any of "AzureServices" or "None".<br>- `customer_managed_key`            = (Optional) - A map of the Customer Managed Key configuration for the Container Registry.<br>  - `key_vault_resource_id`         = (Required) - The Resource ID of the Key Vault that the Customer Managed Key belongs to.<br>  - `key_name`                      = (Required) - The name of the Customer Managed Key.<br>  - `key_version`                   = (Optional) - The version of the Customer Managed Key.<br>  - `user_assigned_identity`        = (Optional) - The User Assigned Identity that has access to the key.<br>    - `resource_id`                 = (Required) - The Resource ID of the User Assigned Identity that has access to the key.<br>- `network_rule`                    = (Optional) - A map of network rules to apply to the Container Registry.<br>  - `default_action`                = (Required) - The default action for the network rules. Valid options are Allow and Deny.<br>  - `ip_rules`                      = (Required) - A list of IP addresses that are allowed to access the Container Registry.<br>- `tags`                            = (Optional) - A mapping of tags to assign to the Container Registry.<br>- `zone_redundancy_enabled`         = (Optional) - Enable or disable zone redundancy for the Container Registry. Defaults to false.<br><br>Example Inputs:<pre>hcl<br>module "acr" "this" {<br>  name              = "acrname"<br>  resource_group_id = "/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/rgname"<br>  location          = "eastus"<br>  sku               = "Basic"<br>  admin_enabled     = false<br>  network_rule      = {<br>    default_action = "Deny"<br>    ip_rules       = [ "</pre>} | <pre>object({<br>    name                          = optional(string)<br>    resource_group_name           = optional(string)<br>    location                      = optional(string)<br>    sku                           = optional(string, "Premium")<br>    anonymous_pull_enabled        = optional(bool, false)<br>    quarantine_policy_enabled     = optional(bool, false)<br>    admin_enabled                 = optional(bool, false)<br>    public_network_access_enabled = optional(bool, false)<br>    export_policy_enabled         = optional(bool, false)<br>    retention_policy_in_days      = optional(number, 7)<br>    network_bypass                = optional(string, "None")<br>    customer_managed_key = optional(object({<br>      key_vault_resource_id = string<br>      key_name              = string<br>      key_version           = optional(string, null)<br>      user_assigned_identity = optional(object({<br>        resource_id = string<br>      }), null)<br>    }))<br>    managed_identities = optional(object({<br>      system_assigned            = optional(bool, false)<br>      user_assigned_resource_ids = optional(set(string), [])<br>    }), {})<br>    network_rule_set = optional(object({<br>      default_action = optional(string, "Deny")<br>      ip_rule = optional(list(object({<br>        # since the `action` property only permits `Allow`, this is hard-coded.<br>        action   = optional(string, "Allow")<br>        ip_range = string<br>      })), [])<br>    }), null)<br>    tags                    = optional(map(string))<br>    zone_redundancy_enabled = optional(bool, false)<br>  })</pre> | `{}` | no |
| <a name="input_diagnostics_log_analytics"></a> [diagnostics\_log\_analytics](#input\_diagnostics\_log\_analytics) | The Log Analytics workspace configuration for diagnostics. | <pre>object({<br>    workspace_id  = string<br>    workspace_key = string<br>  })</pre> | `null` | no |
| <a name="input_dns_name_label"></a> [dns\_name\_label](#input\_dns\_name\_label) | The DNS name label for the container group. | `string` | `null` | no |
| <a name="input_dns_name_servers"></a> [dns\_name\_servers](#input\_dns\_name\_servers) | A list of DNS name servers to use for the container group. | `list(string)` | `[]` | no |
| <a name="input_exposed_ports"></a> [exposed\_ports](#input\_exposed\_ports) | A list of ports to expose on the container group.<br><br>- `port` = (Required) - The port to expose.<br>- `protocol` = (Required) - The protocol to use for the port. Valid options are TCP and UDP. | <pre>list(object({<br>    port     = number<br>    protocol = string<br>  }))</pre> | `[]` | no |
| <a name="input_image_registry_credential"></a> [image\_registry\_credential](#input\_image\_registry\_credential) | The credentials for the image registry. | <pre>map(object({<br>    user_assigned_identity_id = string<br>    server                    = string<br>    username                  = string<br>    password                  = string<br>  }))</pre> | `{}` | no |
| <a name="input_liveness_probe"></a> [liveness\_probe](#input\_liveness\_probe) | - `exec` = (Optional) - The exec probe configuration.<br>- `period_seconds` = (Required) - The period in seconds between probe checks.<br>- `failure_threshold` = (Required) - The number of failures before the probe is considered failed.<br>- `success_threshold` = (Required) - The number of successes before the probe is considered successful.<br>- `timeout_seconds` = (Required) - The timeout in seconds for the probe.<br>- `initial_delay_seconds` = (Required) - The initial delay in seconds before the first probe check.<br>- `http_get` = (Optional) - The HTTP GET probe configuration.<br>- `tcp_socket` = (Optional) - The TCP socket probe configuration. | <pre>object({<br>    exec = object({<br>      command = list(string)<br>    })<br>    period_seconds        = number<br>    failure_threshold     = number<br>    success_threshold     = number<br>    timeout_seconds       = number<br>    initial_delay_seconds = number<br>    http_get = object({<br>      path         = string<br>      port         = number<br>      http_headers = map(string)<br>    })<br>    tcp_socket = object({<br>      port = number<br>    })<br>  })</pre> | `null` | no |
| <a name="input_readiness_probe"></a> [readiness\_probe](#input\_readiness\_probe) | - `exec` = (Optional) - The exec probe configuration.<br>- `period_seconds` = (Required) - The period in seconds between probe checks.<br>- `failure_threshold` = (Required) - The number of failures before the probe is considered failed.<br>- `success_threshold` = (Required) - The number of successes before the probe is considered successful.<br>- `timeout_seconds` = (Required) - The timeout in seconds for the probe.<br>- `initial_delay_seconds` = (Required) - The initial delay in seconds before the first probe check.<br>- `http_get` = (Optional) - The HTTP GET probe configuration.<br>- `tcp_socket` = (Optional) - The TCP socket probe configuration. | <pre>object({<br>    exec = object({<br>      command = list(string)<br>    })<br>    period_seconds        = number<br>    failure_threshold     = number<br>    success_threshold     = number<br>    timeout_seconds       = number<br>    initial_delay_seconds = number<br>    http_get = object({<br>      path         = string<br>      port         = number<br>      http_headers = map(string)<br>    })<br>    tcp_socket = object({<br>      port = number<br>    })<br>  })</pre> | `null` | no |
| <a name="input_resource_group"></a> [resource\_group](#input\_resource\_group) | The name of the resource group in which to create the resources. | <pre>object({<br>    name     = string<br>    location = string<br>  })</pre> | <pre>{<br>  "location": null,<br>  "name": null<br>}</pre> | no |
| <a name="input_tags"></a> [tags](#input\_tags) | A map of tags to assign to the resource. | `map(string)` | `{}` | no |
| <a name="input_zones"></a> [zones](#input\_zones) | A list of availability zones in which the resource should be created. | `list(string)` | `[]` | no |

## Outputs

| Name | Description |
|------|-------------|
| <a name="output_azure_container_registry_admin_password"></a> [azure\_container\_registry\_admin\_password](#output\_azure\_container\_registry\_admin\_password) | n/a |
| <a name="output_azure_container_registry_admin_username"></a> [azure\_container\_registry\_admin\_username](#output\_azure\_container\_registry\_admin\_username) | n/a |
| <a name="output_azure_container_registry_id"></a> [azure\_container\_registry\_id](#output\_azure\_container\_registry\_id) | n/a |
| <a name="output_azure_container_registry_login_server"></a> [azure\_container\_registry\_login\_server](#output\_azure\_container\_registry\_login\_server) | n/a |
| <a name="output_azure_container_registry_name"></a> [azure\_container\_registry\_name](#output\_azure\_container\_registry\_name) | n/a |
| <a name="output_storage_account_id"></a> [storage\_account\_id](#output\_storage\_account\_id) | n/a |
| <a name="output_storage_account_identity"></a> [storage\_account\_identity](#output\_storage\_account\_identity) | n/a |
| <a name="output_storage_account_name"></a> [storage\_account\_name](#output\_storage\_account\_name) | n/a |
<!-- END_TF_DOCS -->

## License

**Copyright:** Schuberg Philis

```text
Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
```
